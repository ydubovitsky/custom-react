<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>Custom-React</title>
</head>

<body>

  <div id="root"></div>

  <script>
    // api
    const api = {
      get(url) {
        switch (url) {
          case "/lots":
            return new Promise((resolve, reject) => {
              setTimeout(() => {
                resolve([{
                    id: 1,
                    title: "Apple",
                    price: 12,
                    text: "Lorem ipsum dolor sit, amet consectetur adipis"
                  },
                  {
                    id: 2,
                    title: "Samsung",
                    price: 451,
                    text: "Lorem ipsum dolor sit, amet consectetur adipis"
                  }
                ])
              }, 3000)
            });
          default: {
            throw new Error("There is no valid url")
          }
        }
      }
    }

    const stream = {
      subscribe(lot, action) {
        setInterval(() => {
          data = {
            id: lot.id,
            price: Math.floor(Math.random() * 10)
          };
          action(data);
        }, 400)
      }
    }

    let state = {
      date: new Date(),
      lots: null
    }

    function App(state) {
      const app = document.createElement("div");
      app.setAttribute("id", "app");
      app.className = "app";

      app.append(Header(), Clock(state.date), Lots(state.lots));
      return app;
    }

    function Header() {
      const header = document.createElement("header");
      header.className = "header";
      const image = document.createElement("img");
      image.className = "logo";
      image.setAttribute("src", "logo.png");

      header.append(image);
      return image;
    }

    function Clock(date) {
      const clockEl = document.createElement("div");
      clockEl.className = "clock";
      clockEl.innerText = date.toLocaleTimeString();
      return clockEl;
    }

    function Lots(lots) {
      const lotsEl = document.createElement("div");
      lotsEl.className = "lots";

      if (lots == null) {
        const notification = document.createElement("p");
        notification.innerText = "Loading...";
        lotsEl.append(notification);
      } else {
        lotsEl.append(...lots.map(lot => Lot(lot)));
      }


      return lotsEl;
    }

    function Lot({
      id,
      title,
      price,
      text
    }) {
      const lotEl = document.createElement("div");
      lotEl.className = "lot";

      const titleEl = document.createElement("h1");
      titleEl.innerHTML = title;

      const priceEl = document.createElement("p");
      priceEl.innerText = price;

      const textEl = document.createElement("p");
      textEl.innerText = text;

      lotEl.append(titleEl, priceEl, textEl);
      return lotEl;
    }

    // Change date every second
    setInterval(() => {
      state = {
        ...state,
        date: new Date()
      }

      renderView(state)

    }, 1000);

    const updateLotPrice = (data) => {
      state = {
        ...state,
        lots: state.lots.map(lot => {
          if (lot.id === data.id) {
            return {
              ...lot,
              price: data.price
            }
          }
          return lot;
        })
      }
    }

    api.get("/lots").then(lots => {
      state = {
        ...state,
        lots
      };

      renderView(state);

      lots.forEach(lot => {
        stream.subscribe(lot, updateLotPrice)
      });
    });

    // Render function
    function render(newDom, realDom) {
      realDom.innerHTML = "";
      realDom.append(newDom);
    }

    // Render view function
    function renderView(state) {
      render(
        App(state),
        document.getElementById("root"))
    }

    // First time execute render function
    renderView();
  </script>
</body>

</html>